#!/bin/bash

# Git Pre-commit Hook para BTC Price Alert
# Este hook se ejecuta automÃ¡ticamente antes de cada commit

echo "ğŸ” Ejecutando verificaciones pre-commit..."

# Verificar si existen archivos que no deberÃ­an estar
BLOCKED_FILES=(
    "btc-price-alert"
    "btc-price-alert.exe"
    "alerts.db"
    ".env"
)

for file in "${BLOCKED_FILES[@]}"; do
    if git diff --cached --name-only | grep -q "^$file$"; then
        echo "âŒ ERROR: Intentando commitear archivo bloqueado: $file"
        echo "ğŸ’¡ Ejecuta: git restore --staged $file"
        exit 1
    fi
done

# Verificar archivos grandes en staging
echo "ğŸ“ Verificando tamaÃ±os de archivos..."
git diff --cached --name-only | while read file; do
    if [ -f "$file" ]; then
        size=$(wc -c < "$file" 2>/dev/null || echo 0)
        # 1MB = 1048576 bytes
        if [ "$size" -gt 1048576 ]; then
            echo "âŒ ERROR: Archivo muy grande para commit: $file ($(echo "scale=2; $size/1048576" | bc)MB)"
            echo "ğŸ’¡ Â¿DeberÃ­a estar en .gitignore?"
            exit 1
        fi
    fi
done

# Verificar formato de cÃ³digo Go
echo "ğŸ¨ Verificando formato de cÃ³digo..."
if [ -n "$(git diff --cached --name-only | grep '\.go$')" ]; then
    # Verificar que el cÃ³digo estÃ© formateado
    unformatted_files=$(git diff --cached --name-only | grep '\.go$' | xargs gofmt -l)
    if [ -n "$unformatted_files" ]; then
        echo "âŒ ERROR: Archivos Go no formateados:"
        echo "$unformatted_files"
        echo "ğŸ’¡ Ejecuta: go fmt ./..."
        exit 1
    fi
fi

# Verificar que las dependencias estÃ©n actualizadas
echo "ğŸ“¦ Verificando dependencias..."
if git diff --cached --name-only | grep -q "go.mod"; then
    if ! go mod verify; then
        echo "âŒ ERROR: go.mod corrupto o dependencias invÃ¡lidas"
        echo "ğŸ’¡ Ejecuta: go mod tidy"
        exit 1
    fi
fi

# Todo OK
echo "âœ… Verificaciones pre-commit completadas exitosamente"
echo "ğŸš€ Procediendo con el commit..." 